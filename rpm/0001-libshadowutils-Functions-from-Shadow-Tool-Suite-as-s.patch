From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Bj=C3=B6rn=20Bidar?= <bjorn.bidar@jolla.com>
Date: Mon, 29 Jan 2024 10:58:30 +0200
Subject: [PATCH] libshadowutils: Functions from Shadow Tool Suite as shared
 library
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Björn Bidar <bjorn.bidar@jolla.com>
---
 CMakeLists.txt          | 79 +++++++++++++++++++++++++++++++++++++++++
 README.libshadowutils   | 20 +++++++++++
 lib/alloc.h             |  1 -
 lib/atoi/a2i.c          |  1 -
 lib/atoi/a2i.h          |  1 -
 lib/atoi/str2i.c        |  1 -
 lib/atoi/str2i.h        |  1 -
 lib/atoi/strtoi.c       |  2 --
 lib/atoi/strtoi.h       |  1 -
 lib/atoi/strtou_noneg.c |  2 --
 lib/atoi/strtou_noneg.h |  1 -
 lib/attr.h              |  1 -
 lib/defines.h           |  4 +--
 lib/getdef.c            | 14 +++++---
 lib/getdef.h            | 16 ++++++++-
 lib/getlong.c           | 30 ++++++++++++++++
 lib/getulong.c          | 34 ++++++++++++++++++
 lib/must_be.h           |  1 -
 lib/prototypes.h        |  2 --
 lib/sizeof.h            |  1 -
 lib/string/sprintf.h    |  2 --
 libshadowutils.pc.in    | 11 ++++++
 test_getdef.c           | 25 +++++++++++++
 23 files changed, 225 insertions(+), 26 deletions(-)
 create mode 100644 CMakeLists.txt
 create mode 100644 README.libshadowutils
 create mode 100644 lib/getlong.c
 create mode 100644 lib/getulong.c
 create mode 100644 libshadowutils.pc.in
 create mode 100644 test_getdef.c

diff --git a/CMakeLists.txt b/CMakeLists.txt
new file mode 100644
index 0000000000000000000000000000000000000000..256ed88c2e2903e0f000ee6d8a62df246132f58c
--- /dev/null
+++ b/CMakeLists.txt
@@ -0,0 +1,79 @@
+cmake_minimum_required(VERSION 3.5)
+
+set(LIBSHADOWUTILS_VERS 4.16.0)
+
+project(libshadowutils
+  LANGUAGES C
+  VERSION ${LIBSHADOWUTILS_VERS})
+
+include(GNUInstallDirs)
+
+add_definitions(-D "\"_(Text)= Text\"")
+
+# We want GNU extensions of libc
+add_definitions(-D_GNU_SOURCE)
+
+file(GLOB LIBSHADOWUTILS_SOURCES
+  "${libshadowutils_SOURCE_DIR}/lib/getdef.c"
+  "${libshadowutils_SOURCE_DIR}/lib/getlong.c"
+  "${libshadowutils_SOURCE_DIR}/lib/getulong.c"
+  "${libshadowutils_SOURCE_DIR}/lib/shadowlog.c"
+  "${libshadowutils_SOURCE_DIR}/lib/atoi/a2i.c"
+  "${libshadowutils_SOURCE_DIR}/lib/atoi/strtoi.c"
+  "${libshadowutils_SOURCE_DIR}/lib/atoi/strtou_noneg.c"
+  "${libshadowutils_SOURCE_DIR}/lib/atoi/str2i.c"
+)
+
+file(GLOB LIBSHADOWUTILS_HEADERS
+  "${libshadowutils_SOURCE_DIR}/lib/getdef.h")
+set(LIBSHADOWUTILS_DOC
+  "README.libshadowutils")
+
+# Shared library
+
+add_library(shadowutils SHARED ${LIBSHADOWUTILS_SOURCES})
+set_target_properties(shadowutils PROPERTIES
+  VERSION ${LIBSHADOWUTILS_VERSION}
+  SOVERSION ${LIBSHADOWUTILS_VERSION_SONAME})
+target_include_directories(shadowutils
+  PRIVATE
+  ${libshadowutils_SOURCE_DIR}
+  ${libshadowutils_SOURCE_DIR}/lib
+  ${CMAKE_CURRENT_BINARY_DIR})
+
+# Unit tests
+
+enable_testing()
+add_executable(test_getdef test_getdef.c)
+target_link_libraries(test_getdef shadowutils)
+add_test(test_getdef test_getdef)
+
+
+# Installation
+
+configure_file(${libshadowutils_SOURCE_DIR}/libshadowutils.pc.in
+  ${CMAKE_CURRENT_BINARY_DIR}/libshadowutils.pc
+  @ONLY)
+
+# Taken from Autoconf
+set(LIBSUBID_ABI_MAJOR 5)
+set(LIBSUBID_ABI_MINOR 0)
+set(LIBSUBID_ABI_MICRO 0)
+set(LIBSUBID_ABI ${LIBSUBID_ABI_MAJOR}.${LIBSUBID_ABI_MINOR}.${LIBSUBID_ABI_MICRO})
+
+configure_file(${libshadowutils_SOURCE_DIR}/libsubid/subid.h.in
+  ${CMAKE_CURRENT_BINARY_DIR}/libsubid/subid.h
+  @ONLY)
+
+install(TARGETS shadowutils
+  RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
+  LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
+  ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR})
+
+install(FILES ${LIBSHADOWUTILS_HEADERS}
+  DESTINATION include/libshadowutils)
+
+install(FILES ${CMAKE_CURRENT_BINARY_DIR}/libshadowutils.pc
+  DESTINATION ${CMAKE_INSTALL_LIBDIR}/pkgconfig)
+install(FILES ${LIBSHADOWUTILS_DOC}
+  DESTINATION ${CMAKE_INSTALL_DOCDIR})
diff --git a/README.libshadowutils b/README.libshadowutils
new file mode 100644
index 0000000000000000000000000000000000000000..b84662fb5ee7b79720965a4afffc8a696d78a1db
--- /dev/null
+++ b/README.libshadowutils
@@ -0,0 +1,20 @@
+libshadowutils: Functions from Shadow Tool Suite as shared library
+------------------------------------------------------------------
+
+This library contains some useful functions from the Shadow Tool Suite
+exposed as shared library to be used by applications not shipped with
+the Shadow Tool Suite.
+
+
+To build:
+
+  mkdir build
+  cd build
+  cmake ..
+  make
+
+
+Files imported from:
+  https://github.com/shadow-maint/shadow/releases/download/4.6/shadow-4.6.tar.xz
+  md5sum: b491fecbf1232632c32ff8f1437fd60e
+  sha1sum: 0b84eb1010fda5edca2a9d1733f9480200e02de6
diff --git a/lib/alloc.h b/lib/alloc.h
index 39405a56fc1d7f602f2b4ba0685fd268f07aae96..036b07eec4c937b55ae656a6631978bb31e866ef 100644
--- a/lib/alloc.h
+++ b/lib/alloc.h
@@ -6,7 +6,6 @@
 #define SHADOW_INCLUDE_LIB_MALLOC_H_
 
 
-#include <config.h>
 
 #include <assert.h>
 #include <errno.h>
diff --git a/lib/atoi/a2i.c b/lib/atoi/a2i.c
index a2cf8723defb49bca6dd55f7238ae2e3b6653118..860952ee7a1d7a5cb0841abab9a6676494afabbb 100644
--- a/lib/atoi/a2i.c
+++ b/lib/atoi/a2i.c
@@ -2,7 +2,6 @@
 // SPDX-License-Identifier: BSD-3-Clause
 
 
-#include <config.h>
 
 #include "atoi/a2i.h"
 
diff --git a/lib/atoi/a2i.h b/lib/atoi/a2i.h
index 64f775a945cd04f4da440a73c9f984aa46cf5b50..7caa65e3b9f4aa8d503c2638bb8d2214962848fd 100644
--- a/lib/atoi/a2i.h
+++ b/lib/atoi/a2i.h
@@ -6,7 +6,6 @@
 #define SHADOW_INCLUDE_LIB_ATOI_A2I_H_
 
 
-#include <config.h>
 
 #include <errno.h>
 
diff --git a/lib/atoi/str2i.c b/lib/atoi/str2i.c
index 25ce3609b052cd0773b4e0d3bffd821a2ed64427..0269b534743463b0e912452062a0f9bb3cfbc0c8 100644
--- a/lib/atoi/str2i.c
+++ b/lib/atoi/str2i.c
@@ -3,7 +3,6 @@
 // SPDX-License-Identifier: BSD-3-Clause
 
 
-#include <config.h>
 
 #include "atoi/str2i.h"
 
diff --git a/lib/atoi/str2i.h b/lib/atoi/str2i.h
index b3ded031005436c35e72f99d6c27650c8dd552d3..7681c465fef523cab8557377b5b9a273421841a8 100644
--- a/lib/atoi/str2i.h
+++ b/lib/atoi/str2i.h
@@ -7,7 +7,6 @@
 #define SHADOW_INCLUDE_LIB_ATOI_STR2I_H_
 
 
-#include <config.h>
 
 #include <limits.h>
 #include <stddef.h>
diff --git a/lib/atoi/strtoi.c b/lib/atoi/strtoi.c
index 197707b1084fcfd61c9053fd7a54dd3543a96616..774dbf7bc9ca835debbec2f67831e3f682ea97cc 100644
--- a/lib/atoi/strtoi.c
+++ b/lib/atoi/strtoi.c
@@ -2,8 +2,6 @@
 // SPDX-License-Identifier: BSD-3-Clause
 
 
-#include <config.h>
-
 #include "atoi/strtoi.h"
 
 #include <stdint.h>
diff --git a/lib/atoi/strtoi.h b/lib/atoi/strtoi.h
index 1f061fc0c62a81ed7bf0c91a2b7e71579d3df66c..9c0c252fbec8bd7a5872008ba0da30f01dcd3ab7 100644
--- a/lib/atoi/strtoi.h
+++ b/lib/atoi/strtoi.h
@@ -6,7 +6,6 @@
 #define SHADOW_INCLUDE_LIB_ATOI_STRTOI_H_
 
 
-#include <config.h>
 
 #include <errno.h>
 #include <inttypes.h>
diff --git a/lib/atoi/strtou_noneg.c b/lib/atoi/strtou_noneg.c
index 71cacbd1e85fe3fe258f46430f0529829c63e6d1..b4d51fc4508ca95930927f050e65d856bdd24106 100644
--- a/lib/atoi/strtou_noneg.c
+++ b/lib/atoi/strtou_noneg.c
@@ -2,8 +2,6 @@
 // SPDX-License-Identifier: BSD-3-Clause
 
 
-#include <config.h>
-
 #include "atoi/strtou_noneg.h"
 
 #include <stdint.h>
diff --git a/lib/atoi/strtou_noneg.h b/lib/atoi/strtou_noneg.h
index 6d77adf5ecd76ffb4d311f3f4c990e0b526b8209..54814016400d61c207a29b1c96d3c2fbe1d26f2a 100644
--- a/lib/atoi/strtou_noneg.h
+++ b/lib/atoi/strtou_noneg.h
@@ -6,7 +6,6 @@
 #define SHADOW_INCLUDE_LIB_ATOI_STRTOU_NONEG_H_
 
 
-#include <config.h>
 
 #include <errno.h>
 #include <stddef.h>
diff --git a/lib/attr.h b/lib/attr.h
index 3835848ddf483eabd4d5c99588506cc7b281ddff..9dfcc93f5d890d3fb6adb34679458ee5f1d666d9 100644
--- a/lib/attr.h
+++ b/lib/attr.h
@@ -2,7 +2,6 @@
 #define SHADOW_INCLUDE_LIB_ATTR_H_
 
 
-#include "config.h"
 
 
 #if defined(__GNUC__)
diff --git a/lib/defines.h b/lib/defines.h
index 8c55dddbc1622083eaa6230124d1700d693416d2..77b42f22cd943fd85d7e975974f78d9f7738c056 100644
--- a/lib/defines.h
+++ b/lib/defines.h
@@ -4,8 +4,6 @@
 #ifndef _DEFINES_H_
 #define _DEFINES_H_
 
-#include "config.h"
-
 #include <stdbool.h>
 #include <locale.h>
 
@@ -20,7 +18,9 @@
 # define bindtextdomain(Domain, Directory)	(NULL)
 # undef textdomain
 # define textdomain(Domain)	(NULL)
+# ifndef _
 # define _(Text) Text
+# endif
 # define ngettext(Msgid1, Msgid2, N) \
     ((N) == 1 ? (const char *) (Msgid1) : (const char *) (Msgid2))
 #endif
diff --git a/lib/getdef.c b/lib/getdef.c
index 30f54bab3159ca618c89ff4c8488b42063a83b11..f640d6bbc024160c9d129a50e1ffde42541ff153 100644
--- a/lib/getdef.c
+++ b/lib/getdef.c
@@ -7,9 +7,10 @@
  * SPDX-License-Identifier: BSD-3-Clause
  */
 
-#include <config.h>
-
-#ident "$Id$"
+#include <stdbool.h>
+#include <stdint.h>
+#include <limits.h>
+#include <string.h>
 
 #include "prototypes.h"
 #include "defines.h"
@@ -73,6 +74,10 @@ struct itemdef {
 	{"MOTD_FIRSTONLY", NULL},		\
 
 
+#define USE_SYSLOG
+#define USE_SHA_CRYPT
+#define WITH_TCB
+
 #define NUMDEFS	(sizeof(def_table)/sizeof(def_table[0]))
 static struct itemdef def_table[] = {
 	{"CHFN_RESTRICT", NULL},
@@ -602,12 +607,11 @@ static void def_load (void)
 }
 #endif /* USE_ECONF */
 
-
 #ifdef CKDEFS
 int main (int argc, char **argv)
 {
 	int i;
-	char *cp;
+	const char *cp;
 	struct itemdef *d;
 
 	def_load ();
diff --git a/lib/getdef.h b/lib/getdef.h
index f55e28b7810eee3d7d9bb867a506d369a91c2e4c..a3be99900dc2f366cac2798f1e5e611fcef935e2 100644
--- a/lib/getdef.h
+++ b/lib/getdef.h
@@ -9,6 +9,12 @@
 #ifndef _GETDEF_H
 #define _GETDEF_H
 
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+#include <stdbool.h>
+
 /* getdef.c */
 extern bool getdef_bool (const char *);
 extern long getdef_long (const char *, long);
@@ -17,9 +23,17 @@ extern unsigned long getdef_ulong (const char *, unsigned long);
 extern unsigned int getdef_unum (const char *, unsigned int);
 extern /*@observer@*/ /*@null@*/const char *getdef_str (const char *);
 extern int putdef_str (const char *, const char *, const char *);
-extern void setdef_config_file (const char* file);
+
+
+/* getlong.c */
+extern int getlong (const char *numstr, /*@out@*/long int *result);
+
 
 /* default UMASK value if not specified in /etc/login.defs */
 #define		GETDEF_DEFAULT_UMASK	022
 
+#ifdef __cplusplus
+}
+#endif
+
 #endif				/* _GETDEF_H */
diff --git a/lib/getlong.c b/lib/getlong.c
new file mode 100644
index 0000000000000000000000000000000000000000..67d69f7db9a825cbb11e0e225f6c03124acbf794
--- /dev/null
+++ b/lib/getlong.c
@@ -0,0 +1,30 @@
+/*
+ * SPDX-FileCopyrightText: 2007 - 2009, Nicolas François
+ *
+ * SPDX-License-Identifier: BSD-3-Clause
+ */
+
+#include <stdlib.h>
+#include <errno.h>
+
+/*
+ * getlong - extract a long integer provided by the numstr string in *result
+ *
+ * It supports decimal, hexadecimal or octal representations.
+ *
+ * Returns 0 on failure, 1 on success.
+ */
+int getlong (const char *numstr, /*@out@*/long int *result)
+{
+	long val;
+	char *endptr;
+
+	errno = 0;
+	val = strtol (numstr, &endptr, 0);
+	if (('\0' == *numstr) || ('\0' != *endptr) || (ERANGE == errno)) {
+		return 0;
+	}
+
+	*result = val;
+	return 1;
+}
diff --git a/lib/getulong.c b/lib/getulong.c
new file mode 100644
index 0000000000000000000000000000000000000000..5f74e0d0191237319db6cc7ec28e6507a05472d9
--- /dev/null
+++ b/lib/getulong.c
@@ -0,0 +1,34 @@
+/*
+ * SPDX-FileCopyrightText: 2007 - 2009, Nicolas François
+ *
+ * SPDX-License-Identifier: BSD-3-Clause
+ */
+
+#include <stdlib.h>
+#include <errno.h>
+
+/*
+ * getulong - extract an unsigned long integer provided by the numstr string in *result
+ *
+ * It supports decimal, hexadecimal or octal representations.
+ *
+ * Returns 0 on failure, 1 on success.
+ */
+int getulong (const char *numstr, /*@out@*/unsigned long int *result)
+{
+	unsigned long int val;
+	char *endptr;
+
+	errno = 0;
+	val = strtoul (numstr, &endptr, 0);
+	if (    ('\0' == *numstr)
+	     || ('\0' != *endptr)
+	     || (ERANGE == errno)
+	   ) {
+		return 0;
+	}
+
+	*result = val;
+	return 1;
+}
+
diff --git a/lib/must_be.h b/lib/must_be.h
index a7365cba53f36ab692147410fd35cf07fd5189a5..b54214e3f7387874b763018f595b232a48d2881e 100644
--- a/lib/must_be.h
+++ b/lib/must_be.h
@@ -8,7 +8,6 @@
 #define SHADOW_INCLUDE_LIBMISC_MUST_BE_H_
 
 
-#include <config.h>
 
 #include <assert.h>
 
diff --git a/lib/prototypes.h b/lib/prototypes.h
index 91ff368b79b6e51522950d8932500bf1b677f659..a15a45c52dd876a272229d9975fea3e9f8456fe6 100644
--- a/lib/prototypes.h
+++ b/lib/prototypes.h
@@ -19,8 +19,6 @@
 #ifndef _PROTOTYPES_H
 #define _PROTOTYPES_H
 
-#include <config.h>
-
 #include <sys/socket.h>
 #include <sys/stat.h>
 #include <sys/types.h>
diff --git a/lib/sizeof.h b/lib/sizeof.h
index 6847068eacb0da894d945ecfb1dc0f4ba124fb72..eb1f1e63b00ff8f534e2022ff05a810c4e505d0a 100644
--- a/lib/sizeof.h
+++ b/lib/sizeof.h
@@ -8,7 +8,6 @@
 #define SHADOW_INCLUDE_LIBMISC_SIZEOF_H_
 
 
-#include <config.h>
 
 #include <limits.h>
 
diff --git a/lib/string/sprintf.h b/lib/string/sprintf.h
index 748536943234da91afaa172576cf890ed12f2d48..56d70ad6e0e515c5f2c76bf1dfdb8b282031226a 100644
--- a/lib/string/sprintf.h
+++ b/lib/string/sprintf.h
@@ -8,8 +8,6 @@
 #define SHADOW_INCLUDE_LIB_SPRINTF_H_
 
 
-#include <config.h>
-
 #include <stdarg.h>
 #include <stddef.h>
 #include <stdio.h>
diff --git a/libshadowutils.pc.in b/libshadowutils.pc.in
new file mode 100644
index 0000000000000000000000000000000000000000..912e871abd043ea1998c97bb03acf57e487647c8
--- /dev/null
+++ b/libshadowutils.pc.in
@@ -0,0 +1,11 @@
+prefix=@CMAKE_INSTALL_PREFIX@
+exec_prefix=${prefix}
+libdir=${prefix}/@LIB_DEST@
+includedir=${prefix}/include/libshadowutils
+
+Name: libshadowutils
+Description: Shared Library with functions from pkg-shadow
+URL: http://pkg-shadow.alioth.debian.org/
+Version: @LIBSHADOWUTILS_VERSION@
+Libs: -L${libdir} -lshadowutils
+Cflags: -I${includedir}
diff --git a/test_getdef.c b/test_getdef.c
new file mode 100644
index 0000000000000000000000000000000000000000..f698019e58328eeb1a9763c507a82193cde35c84
--- /dev/null
+++ b/test_getdef.c
@@ -0,0 +1,25 @@
+#include "lib/getdef.h"
+
+#include <stdio.h>
+#include <stdlib.h>
+
+int
+get_or_fail(const char *key)
+{
+    int result = getdef_num(key, -1);
+    if (result == -1) {
+        fprintf(stderr, "ERROR: Cannot get value for '%s'\n", key);
+        exit(1);
+    }
+    return result;
+}
+
+int
+main(int argc, char *argv[])
+{
+    int uid_min = get_or_fail("UID_MIN");
+    int uid_max = get_or_fail("UID_MAX");
+
+    fprintf(stdout, "User ID Range: %d..%d\n", uid_min, uid_max);
+    return 0;
+}
